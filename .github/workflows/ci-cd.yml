name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: "3.9"
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    - name: Run tests
      run: |
        python -m pytest

jobs:
  # ...测试阶段保持不变...

  deploy-dev:
    needs: test
    runs-on: ubuntu-latest
    environment: dev
    steps:
    - uses: actions/checkout@v3
    - name: Deploy to Dev
      env:
        API_KEY: ${{ secrets.DEV_API_KEY }}
      run: |
        cloudstudio deploy --api-key $API_KEY --env dev

  deploy-stage:
    needs: deploy-dev
    runs-on: ubuntu-latest
    environment: stage
    steps:
    - uses: actions/checkout@v3
    - name: Deploy to Stage
      env:
        API_KEY: ${{ secrets.STAGE_API_KEY }}
      run: |
        cloudstudio deploy --api-key $API_KEY --env stage

  deploy-prod:
    needs: deploy-stage
    runs-on: ubuntu-latest
    environment: 
      name: production
      url: https://cloudstudio.com/your-project
    steps:
    - uses: actions/checkout@v3
    - name: Approve Production Deploy
      uses: trstringer/manual-approval@v1
      with:
        secret: ${{ github.token }}
        approvers: "your-github-username"
    - name: Deploy to Prod
      env:
        API_KEY: ${{ secrets.PROD_API_KEY }}
      run: |
        cloudstudio deploy --api-key $API_KEY --env prod